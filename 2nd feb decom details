InProgressForDetails = 
VAR YearIsSel  = HASONEVALUE ( 'Calendar'[Year] )
VAR MonthIsSel = HASONEVALUE ( 'Calendar'[Month] )
VAR NoneSelected = NOT YearIsSel && NOT MonthIsSel
 
/* Target date from slicer */
VAR TargetDateFromSlicer =
    IF (
        MonthIsSel,
        CALCULATE (
            MAX ( 'Calendar'[Date] ),
            ALLEXCEPT ( 'Calendar', 'Calendar'[Year], 'Calendar'[Month] )
        ),
        IF (
            YearIsSel,
            CALCULATE (
                MAX ( 'Calendar'[Date] ),
                ALLEXCEPT ( 'Calendar', 'Calendar'[Year] )
            )
        )
    )
 
/* Latest snapshot overall */
VAR LatestExtractDate =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        ALL ( 'Decommissioning Apps' )
    )
 
/* Month window for Date extracted */
VAR ExtractMonthStart =
    IF (
        MonthIsSel,
        DATE ( YEAR ( TargetDateFromSlicer ), MONTH ( TargetDateFromSlicer ), 1 ),
        DATE ( YEAR ( LatestExtractDate ), MONTH ( LatestExtractDate ), 1 )
    )
 
VAR ExtractMonthEnd =
    IF (
        MonthIsSel,
        EOMONTH ( TargetDateFromSlicer, 0 ),
        EOMONTH ( LatestExtractDate, 0 )
    )
 
/* Year logic */
VAR ForecastYear =
    IF (
        YearIsSel || MonthIsSel,
        YEAR ( TargetDateFromSlicer ),
        YEAR ( LatestExtractDate )
    )
 
/* Year-only: latest extract month in that year */
VAR LatestExtractInYear =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        FILTER (
            ALL ( 'Decommissioning Apps' ),
            YEAR ( 'Decommissioning Apps'[Date extracted] ) = ForecastYear
        )
    )
 
VAR YearOnlyExtractStart =
    DATE ( ForecastYear, MONTH ( LatestExtractInYear ), 1 )
 
VAR YearOnlyExtractEnd =
    EOMONTH ( LatestExtractInYear, 0 )
 
RETURN
IF (
    MonthIsSel || NoneSelected,
    /* Month selected OR nothing selected */
    CALCULATE (
        COUNTROWS ( 'Decommissioning Apps' ),
        'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
        DATESBETWEEN (
            'Decommissioning Apps'[Date extracted],
            ExtractMonthStart,
            ExtractMonthEnd
        ),
        DATESBETWEEN (
            'Decommissioning Apps'[Forecast end Date],
            DATE ( ForecastYear, 1, 1 ),
            DATE ( ForecastYear, 12, 31 )
        )
    ),
    /* Only year selected */
    CALCULATE (
        COUNTROWS ( 'Decommissioning Apps' ),
        'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
        DATESBETWEEN (
            'Decommissioning Apps'[Date extracted],
            YearOnlyExtractStart,
            YearOnlyExtractEnd
        ),
        DATESBETWEEN (
            'Decommissioning Apps'[Forecast end Date],
            DATE ( ForecastYear, 1, 1 ),
            DATE ( ForecastYear, 12, 31 )
        )
    )
)

--------------------------

InProgressForDetails =
VAR YearIsSel  = HASONEVALUE ( 'Calendar'[Year] )
VAR MonthIsSel = HASONEVALUE ( 'Calendar'[Month] )
VAR NoneSelected = NOT YearIsSel && NOT MonthIsSel

/* Target date from slicer (SHIFTED to previous month) */
VAR TargetDateFromSlicer =
    IF (
        MonthIsSel,
        EOMONTH (
            CALCULATE (
                MAX ( 'Calendar'[Date] ),
                ALLEXCEPT ( 'Calendar', 'Calendar'[Year], 'Calendar'[Month] )
            ),
            -1
        ),
        IF (
            YearIsSel,
            EOMONTH (
                CALCULATE (
                    MAX ( 'Calendar'[Date] ),
                    ALLEXCEPT ( 'Calendar', 'Calendar'[Year] )
                ),
                -1
            )
        )
    )

/* Latest snapshot overall */
VAR LatestExtractDate =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        ALL ( 'Decommissioning Apps' )
    )

/* Month window for Date extracted */
VAR ExtractMonthStart =
    IF (
        MonthIsSel,
        DATE ( YEAR ( TargetDateFromSlicer ), MONTH ( TargetDateFromSlicer ), 1 ),
        DATE ( YEAR ( LatestExtractDate ), MONTH ( LatestExtractDate ), 1 )
    )

VAR ExtractMonthEnd =
    IF (
        MonthIsSel,
        EOMONTH ( TargetDateFromSlicer, 0 ),
        EOMONTH ( LatestExtractDate, 0 )
    )

/* Year logic */
VAR ForecastYear =
    IF (
        YearIsSel || MonthIsSel,
        YEAR ( TargetDateFromSlicer ),
        YEAR ( LatestExtractDate )
    )

/* Year-only: latest extract month in that year */
VAR LatestExtractInYear =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        FILTER (
            ALL ( 'Decommissioning Apps' ),
            YEAR ( 'Decommissioning Apps'[Date extracted] ) = ForecastYear
        )
    )

VAR YearOnlyExtractStart =
    DATE ( ForecastYear, MONTH ( LatestExtractInYear ), 1 )

VAR YearOnlyExtractEnd =
    EOMONTH ( LatestExtractInYear, 0 )

RETURN
IF (
    MonthIsSel || NoneSelected,
    /* Month selected OR nothing selected */
    CALCULATE (
        COUNTROWS ( 'Decommissioning Apps' ),
        'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
        DATESBETWEEN (
            'Decommissioning Apps'[Date extracted],
            ExtractMonthStart,
            ExtractMonthEnd
        ),
        DATESBETWEEN (
            'Decommissioning Apps'[Forecast end Date],
            DATE ( ForecastYear, 1, 1 ),
            DATE ( ForecastYear, 12, 31 )
        )
    ),
    /* Only year selected */
    CALCULATE (
        COUNTROWS ( 'Decommissioning Apps' ),
        'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
        DATESBETWEEN (
            'Decommissioning Apps'[Date extracted],
            YearOnlyExtractStart,
            YearOnlyExtractEnd
        ),
        DATESBETWEEN (
            'Decommissioning Apps'[Forecast end Date],
            DATE ( ForecastYear, 1, 1 ),
            DATE ( ForecastYear, 12, 31 )
        )
    )
)

