InProgressForDetails = 
VAR YearIsSel  = HASONEVALUE ( 'Calendar'[Year] )
VAR MonthIsSel = HASONEVALUE ( 'Calendar'[Month] )
VAR NoneSelected = NOT YearIsSel && NOT MonthIsSel
 
/* Target date from slicer */
VAR TargetDateFromSlicer =
    IF (
        MonthIsSel,
        CALCULATE (
            MAX ( 'Calendar'[Date] ),
            ALLEXCEPT ( 'Calendar', 'Calendar'[Year], 'Calendar'[Month] )
        ),
        IF (
            YearIsSel,
            CALCULATE (
                MAX ( 'Calendar'[Date] ),
                ALLEXCEPT ( 'Calendar', 'Calendar'[Year] )
            )
        )
    )
 
/* Latest snapshot overall */
VAR LatestExtractDate =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        ALL ( 'Decommissioning Apps' )
    )
 
/* Month window for Date extracted */
VAR ExtractMonthStart =
    IF (
        MonthIsSel,
        DATE ( YEAR ( TargetDateFromSlicer ), MONTH ( TargetDateFromSlicer ), 1 ),
        DATE ( YEAR ( LatestExtractDate ), MONTH ( LatestExtractDate ), 1 )
    )
 
VAR ExtractMonthEnd =
    IF (
        MonthIsSel,
        EOMONTH ( TargetDateFromSlicer, 0 ),
        EOMONTH ( LatestExtractDate, 0 )
    )
 
/* Year logic */
VAR ForecastYear =
    IF (
        YearIsSel || MonthIsSel,
        YEAR ( TargetDateFromSlicer ),
        YEAR ( LatestExtractDate )
    )
 
/* Year-only: latest extract month in that year */
VAR LatestExtractInYear =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        FILTER (
            ALL ( 'Decommissioning Apps' ),
            YEAR ( 'Decommissioning Apps'[Date extracted] ) = ForecastYear
        )
    )
 
VAR YearOnlyExtractStart =
    DATE ( ForecastYear, MONTH ( LatestExtractInYear ), 1 )
 
VAR YearOnlyExtractEnd =
    EOMONTH ( LatestExtractInYear, 0 )
 
RETURN
IF (
    MonthIsSel || NoneSelected,
    /* Month selected OR nothing selected */
    CALCULATE (
        COUNTROWS ( 'Decommissioning Apps' ),
        'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
        DATESBETWEEN (
            'Decommissioning Apps'[Date extracted],
            ExtractMonthStart,
            ExtractMonthEnd
        ),
        DATESBETWEEN (
            'Decommissioning Apps'[Forecast end Date],
            DATE ( ForecastYear, 1, 1 ),
            DATE ( ForecastYear, 12, 31 )
        )
    ),
    /* Only year selected */
    CALCULATE (
        COUNTROWS ( 'Decommissioning Apps' ),
        'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
        DATESBETWEEN (
            'Decommissioning Apps'[Date extracted],
            YearOnlyExtractStart,
            YearOnlyExtractEnd
        ),
        DATESBETWEEN (
            'Decommissioning Apps'[Forecast end Date],
            DATE ( ForecastYear, 1, 1 ),
            DATE ( ForecastYear, 12, 31 )
        )
    )
)

--------------------------

InProgressForDetails =
VAR YearIsSel  = HASONEVALUE ( 'Calendar'[Year] )
VAR MonthIsSel = HASONEVALUE ( 'Calendar'[Month] )
VAR NoneSelected = NOT YearIsSel && NOT MonthIsSel

/* Target date from slicer (SHIFTED to previous month) */
VAR TargetDateFromSlicer =
    IF (
        MonthIsSel,
        EOMONTH (
            CALCULATE (
                MAX ( 'Calendar'[Date] ),
                ALLEXCEPT ( 'Calendar', 'Calendar'[Year], 'Calendar'[Month] )
            ),
            -1
        ),
        IF (
            YearIsSel,
            EOMONTH (
                CALCULATE (
                    MAX ( 'Calendar'[Date] ),
                    ALLEXCEPT ( 'Calendar', 'Calendar'[Year] )
                ),
                -1
            )
        )
    )

/* Latest snapshot overall */
VAR LatestExtractDate =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        ALL ( 'Decommissioning Apps' )
    )

/* Month window for Date extracted */
VAR ExtractMonthStart =
    IF (
        MonthIsSel,
        DATE ( YEAR ( TargetDateFromSlicer ), MONTH ( TargetDateFromSlicer ), 1 ),
        DATE ( YEAR ( LatestExtractDate ), MONTH ( LatestExtractDate ), 1 )
    )

VAR ExtractMonthEnd =
    IF (
        MonthIsSel,
        EOMONTH ( TargetDateFromSlicer, 0 ),
        EOMONTH ( LatestExtractDate, 0 )
    )

/* Year logic */
VAR ForecastYear =
    IF (
        YearIsSel || MonthIsSel,
        YEAR ( TargetDateFromSlicer ),
        YEAR ( LatestExtractDate )
    )

/* Year-only: latest extract month in that year */
VAR LatestExtractInYear =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        FILTER (
            ALL ( 'Decommissioning Apps' ),
            YEAR ( 'Decommissioning Apps'[Date extracted] ) = ForecastYear
        )
    )

VAR YearOnlyExtractStart =
    DATE ( ForecastYear, MONTH ( LatestExtractInYear ), 1 )

VAR YearOnlyExtractEnd =
    EOMONTH ( LatestExtractInYear, 0 )

RETURN
IF (
    MonthIsSel || NoneSelected,
    /* Month selected OR nothing selected */
    CALCULATE (
        COUNTROWS ( 'Decommissioning Apps' ),
        'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
        DATESBETWEEN (
            'Decommissioning Apps'[Date extracted],
            ExtractMonthStart,
            ExtractMonthEnd
        ),
        DATESBETWEEN (
            'Decommissioning Apps'[Forecast end Date],
            DATE ( ForecastYear, 1, 1 ),
            DATE ( ForecastYear, 12, 31 )
        )
    ),
    /* Only year selected */
    CALCULATE (
        COUNTROWS ( 'Decommissioning Apps' ),
        'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
        DATESBETWEEN (
            'Decommissioning Apps'[Date extracted],
            YearOnlyExtractStart,
            YearOnlyExtractEnd
        ),
        DATESBETWEEN (
            'Decommissioning Apps'[Forecast end Date],
            DATE ( ForecastYear, 1, 1 ),
            DATE ( ForecastYear, 12, 31 )
        )
    )
)
------------------------------------------------
InProgressForDetails =
VAR YearIsSel  = HASONEVALUE ( 'Calendar'[Year] )
VAR MonthIsSel = HASONEVALUE ( 'Calendar'[Month] )
VAR NoneSelected = NOT YearIsSel && NOT MonthIsSel

/* Selected month/year anchor from slicer */
VAR TargetDateFromSlicer =
    IF (
        MonthIsSel,
        CALCULATE (
            MAX ( 'Calendar'[Date] ),
            ALLEXCEPT ( 'Calendar', 'Calendar'[Year], 'Calendar'[Month] )
        ),
        IF (
            YearIsSel,
            CALCULATE (
                MAX ( 'Calendar'[Date] ),
                ALLEXCEPT ( 'Calendar', 'Calendar'[Year] )
            )
        )
    )

/* Latest extract overall */
VAR LatestExtractDate =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        ALL ( 'Decommissioning Apps' )
    )

/* Previous month (when month is selected) */
VAR PrevMonthAnchorDate =
    IF ( MonthIsSel, EOMONTH ( TargetDateFromSlicer, -1 ), BLANK () )

/* Which year to use for Forecast end Date filter
   - If Month selected: use PREVIOUS monthâ€™s year (Jan 2026 -> 2025)
   - If only Year selected: use selected year
   - If nothing selected: use latest extract year
*/
VAR ForecastYear =
    IF (
        MonthIsSel,
        YEAR ( PrevMonthAnchorDate ),
        IF ( YearIsSel, YEAR ( TargetDateFromSlicer ), YEAR ( LatestExtractDate ) )
    )

/* Date extracted window */
VAR ExtractMonthStart =
    IF (
        MonthIsSel,
        DATE ( YEAR ( PrevMonthAnchorDate ), MONTH ( PrevMonthAnchorDate ), 1 ),
        DATE ( YEAR ( LatestExtractDate ), MONTH ( LatestExtractDate ), 1 )
    )

VAR ExtractMonthEnd =
    IF (
        MonthIsSel,
        EOMONTH ( PrevMonthAnchorDate, 0 ),
        EOMONTH ( LatestExtractDate, 0 )
    )

/* Year-only logic: use latest extract month WITHIN the selected year */
VAR LatestExtractInYear =
    CALCULATE (
        MAX ( 'Decommissioning Apps'[Date extracted] ),
        FILTER (
            ALL ( 'Decommissioning Apps' ),
            YEAR ( 'Decommissioning Apps'[Date extracted] ) = ForecastYear
        )
    )

VAR YearOnlyExtractStart =
    DATE ( ForecastYear, MONTH ( LatestExtractInYear ), 1 )

VAR YearOnlyExtractEnd =
    EOMONTH ( LatestExtractInYear, 0 )

/* If selected year has no data at all -> return 0 */
VAR HasDataForYear =
    NOT ISBLANK ( LatestExtractInYear )

RETURN
IF (
    (YearIsSel || MonthIsSel) && NOT HasDataForYear,
    0,
    IF (
        MonthIsSel || NoneSelected,
        CALCULATE (
            COUNTROWS ( 'Decommissioning Apps' ),
            REMOVEFILTERS ( 'Calendar' ),  -- IMPORTANT: prevents conflict with slicer
            'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
            DATESBETWEEN (
                'Decommissioning Apps'[Date extracted],
                ExtractMonthStart,
                ExtractMonthEnd
            ),
            DATESBETWEEN (
                'Decommissioning Apps'[Forecast end Date],
                DATE ( ForecastYear, 1, 1 ),
                DATE ( ForecastYear, 12, 31 )
            )
        ) + 0,
        CALCULATE (
            COUNTROWS ( 'Decommissioning Apps' ),
            REMOVEFILTERS ( 'Calendar' ),  -- IMPORTANT
            'Decommissioning Apps'[Phase] IN { "Baselining", "Not Started", "No entry" },
            DATESBETWEEN (
                'Decommissioning Apps'[Date extracted],
                YearOnlyExtractStart,
                YearOnlyExtractEnd
            ),
            DATESBETWEEN (
                'Decommissioning Apps'[Forecast end Date],
                DATE ( ForecastYear, 1, 1 ),
                DATE ( ForecastYear, 12, 31 )
            )
        ) + 0
    )
)
