CompletedCount :=
VAR YearIsSel  = HASONEVALUE ( 'Calendar'[Year] )
VAR MonthIsSel = HASONEVALUE ( 'Calendar'[Month] )

/* pick a target date based on slicer */
VAR TargetDate =
    IF (
        MonthIsSel,
        CALCULATE (
            MAX ( 'Calendar'[Date] ),
            ALLEXCEPT ( 'Calendar', 'Calendar'[Year], 'Calendar'[Month] )
        ),
        IF (
            YearIsSel,
            CALCULATE (
                MAX ( 'Calendar'[Date] ),
                ALLEXCEPT ( 'Calendar', 'Calendar'[Year] )
            ),
            CALCULATE (
                MAX ( 'Decommissioning Apps'[Forecast Date] ),
                ALL ( 'Decommissioning Apps' )
            )
        )
    )

VAR StartDate =
    IF ( MonthIsSel,
        DATE ( YEAR ( TargetDate ), MONTH ( TargetDate ), 1 ),
        DATE ( YEAR ( TargetDate ), 1, 1 )
    )

VAR EndDate =
    IF ( MonthIsSel,
        EOMONTH ( TargetDate, 0 ),
        DATE ( YEAR ( TargetDate ), 12, 31 )
    )

RETURN
CALCULATE (
    COUNTROWS ( 'Decommissioning Apps' ),
    'Decommissioning Apps'[Phase] = "Completed",
    DATESBETWEEN ( 'Decommissioning Apps'[Forecast Date], StartDate, EndDate )
) + 0




let
    Source = Excel.Workbook(File.Contents("C:\Users\DMUQ6RG\Downloads\Decomissioning_Compiled jan 2025-Jan 2026 (2).xlsx"), null, true),
    #"Decom Plan Compiled_Sheet" = Source{[Item="Decom Plan Compiled",Kind="Sheet"]}[Data],
    #"Promoted Headers" = Table.PromoteHeaders(#"Decom Plan Compiled_Sheet", [PromoteAllScalars=true]),
    #"Changed Type" = Table.TransformColumnTypes(#"Promoted Headers",{{"Name", type text}, {"OE Code", type text}, {"Plan Column(PD)", Int64.Type}}),
    #"Renamed Columns" = Table.RenameColumns(#"Changed Type",{{"Year", "Date"}}),
    #"Changed Type1" = Table.TransformColumnTypes(#"Renamed Columns",{{"Date", type date}})
in
    #"Changed Type1"




PlanValue :=
VAR SelectedYear =
    COALESCE( SELECTEDVALUE('Calendar'[Year]), YEAR(TODAY()) )
RETURN
CALCULATE(
    SUM('Decom Plan Compiled'[Plan Column(PD)]),
    FILTER(
        ALL('Decom Plan Compiled'),
        YEAR('Decom Plan Compiled'[Year]) = SelectedYear
    )
)

