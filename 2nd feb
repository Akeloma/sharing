Filter - Decommissioning Apps = 
VAR SelectedYear = SELECTEDVALUE(YearParameter[Year])

RETURN
FILTER(
    'Decommissioning Apps',
    YEAR('Decommissioning Apps'[Forecast End Date]) = SelectedYear &&
    'Decommissioning Apps'[Phase] = "Completed"
)


D = 
CALCULATE(
    COUNTROWS('Filter - Decommissioning Apps'),
    FILTER(
        'Filter - Decommissioning Apps',
        'Filter - Decommissioning Apps'[ID_4] = 'IT Architecture'[ID]
    )
)


DCount = SUM('IT Architecture'[D])+0




Decommissioned Apps Count = 
VAR YearIsSel = HASONEVALUE('Calendar'[Year])
VAR MonthIsSel = HASONEVALUE('Calendar'[Month])

/* Pick a single target date based on slicers */
VAR TargetDate = 
    IF(
        MonthIsSel,
        CALCULATE(
            MAX('Decommissioning Apps'[Date extracted]),
            ALLEXCEPT('Calendar', 'Calendar'[Year], 'Calendar'[Month])
        ),
        IF(
            YearIsSel,
            CALCULATE(
                MAX('Decommissioning Apps'[Date extracted]),
                ALLEXCEPT('Calendar', 'Calendar'[Year])
            ),
            CALCULATE(
                MAX('Decommissioning Apps'[Date extracted]),
                ALL('Decommissioning Apps')
            )
        )
    )

RETURN
IF(
    ISBLANK(TargetDate),
    0,
    VAR StartOfMonth = DATE(YEAR(TargetDate), MONTH(TargetDate), 1)
    VAR EndOfMonth = EOMONTH(TargetDate, 0)
    VAR TargetYear = YEAR(TargetDate)
    
    /* Get list of IDs from Decommissioning Apps that match criteria */
    VAR ValidIDs = 
        CALCULATETABLE(
            VALUES('Decommissioning Apps'[ID]),
            'Decommissioning Apps'[Date extracted] >= StartOfMonth,
            'Decommissioning Apps'[Date extracted] <= EndOfMonth,
            YEAR('Decommissioning Apps'[Forecast End Date]) = TargetYear,
            'Decommissioning Apps'[Phase] = "Completed"
        )
    
    /* Count matching rows in IT Architecture table */
    VAR Result_ = 
        CALCULATE(
            COUNTROWS('IT Architecture'),
            'IT Architecture'[Date extracted] >= StartOfMonth,
            'IT Architecture'[Date extracted] <= EndOfMonth,
            'IT Architecture'[ID] IN ValidIDs
        )


--------------------------------------------------------------------------------


Completed Apps (Arch Count) :=
VAR YearIsSel  = HASONEVALUE ( 'Calendar'[Year] )
VAR MonthIsSel = HASONEVALUE ( 'Calendar'[Month] )

-- Pick the “target extract date” based on slicers
VAR TargetDate =
    IF (
        MonthIsSel,
            CALCULATE (
                MAX ( 'Decommissioning Apps'[Date extracted] ),
                ALLEXCEPT ( 'Calendar', 'Calendar'[Year], 'Calendar'[Month] )
            ),
        IF (
            YearIsSel,
                CALCULATE (
                    MAX ( 'Decommissioning Apps'[Date extracted] ),
                    ALLEXCEPT ( 'Calendar', 'Calendar'[Year] )
                ),
            CALCULATE (
                MAX ( 'Decommissioning Apps'[Date extracted] ),
                ALL ( 'Decommissioning Apps' )
            )
        )
    )

RETURN
IF (
    ISBLANK ( TargetDate ),
    0,
    VAR StartOfMonth = DATE ( YEAR ( TargetDate ), MONTH ( TargetDate ), 1 )
    VAR EndOfMonth   = EOMONTH ( TargetDate, 0 )

    -- ✅ NEW: Forecast End Date should be anywhere in the selected YEAR
    VAR StartOfYear = DATE ( YEAR ( TargetDate ), 1, 1 )
    VAR EndOfYear   = DATE ( YEAR ( TargetDate ), 12, 31 )

    VAR FilteredIDs =
        CALCULATETABLE (
            VALUES ( 'Decommissioning Apps'[ID_4] ),
            'Decommissioning Apps'[Phase] = "Completed",

            -- Step 3: Date extracted = selected month (based on TargetDate month)
            'Decommissioning Apps'[Date extracted] >= StartOfMonth,
            'Decommissioning Apps'[Date extracted] <= EndOfMonth,

            -- ✅ Step 4: Forecast End Date = anywhere in that YEAR
            'Decommissioning Apps'[Forecast End Date] >= StartOfYear,
            'Decommissioning Apps'[Forecast End Date] <= EndOfYear
        )

    VAR Result =
        CALCULATE (
            COUNTROWS ( 'IT Architecture' ),
            KEEPFILTERS ( TREATAS ( FilteredIDs, 'IT Architecture'[ID] ) )
        )
    RETURN COALESCE ( Result, 0 )
)




----------------------------------------------------------------------------


Completed Apps (Arch Count) :=
VAR YearIsSel  = HASONEVALUE ( 'Calendar'[Year] )
VAR MonthIsSel = HASONEVALUE ( 'Calendar'[Month] )

VAR TargetDate =
    IF (
        MonthIsSel,
            CALCULATE (
                MAX ( 'Decommissioning Apps'[Date extracted] ),
                ALLEXCEPT ( 'Calendar', 'Calendar'[Year], 'Calendar'[Month] )
            ),
        IF (
            YearIsSel,
                CALCULATE (
                    MAX ( 'Decommissioning Apps'[Date extracted] ),
                    ALLEXCEPT ( 'Calendar', 'Calendar'[Year] )
                ),
                CALCULATE (
                    MAX ( 'Decommissioning Apps'[Date extracted] ),
                    ALL ( 'Decommissioning Apps' )
                )
        )
    )

RETURN
IF (
    ISBLANK ( TargetDate ),
    0,
    VAR StartOfMonth = DATE ( YEAR ( TargetDate ), MONTH ( TargetDate ), 1 )
    VAR EndOfMonth   = EOMONTH ( TargetDate, 0 )

    VAR StartOfYear = DATE ( YEAR ( TargetDate ), 1, 1 )
    VAR EndOfYear   = DATE ( YEAR ( TargetDate ), 12, 31 )

    VAR FilteredIDs =
        CALCULATETABLE (
            VALUES ( 'Decommissioning Apps'[ID_4] ),
            'Decommissioning Apps'[Phase] = "Completed",
            'Decommissioning Apps'[Date extracted] >= StartOfMonth,
            'Decommissioning Apps'[Date extracted] <= EndOfMonth,
            'Decommissioning Apps'[Forecast End Date] >= StartOfYear,
            'Decommissioning Apps'[Forecast End Date] <= EndOfYear
        )

    VAR Result =
        CALCULATE (
            COUNTROWS ( 'IT Architecture' ),

            -- ✅ Force Architecture to the SAME “latest extract month” even when slicers are blank
            REMOVEFILTERS ( 'Calendar' ),
            DATESBETWEEN ( 'Calendar'[Date], StartOfMonth, EndOfMonth ),

            -- Match IDs from filtered decom list
            KEEPFILTERS ( TREATAS ( FilteredIDs, 'IT Architecture'[ID] ) )
        )
    RETURN COALESCE ( Result, 0 )
)

